<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma de Trabajo | SPRC</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS para manejar Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Office.js para Excel -->
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos base */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8fafc; }
        .gantt-container { overflow-x: auto; padding-bottom: 20px; }
        .gantt-header-cell { min-width: 40px; text-align: center; font-size: 0.75rem; border-right: 1px solid #e2e8f0; }
        .gantt-bar { transition: all 0.3s ease; }
        .gantt-bar:hover { filter: brightness(1.1); transform: scaleY(1.1); }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // Definición manual de iconos para evitar errores de renderizado con librerías CDN
        const Icons = {
            Edit2: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                </svg>
            ),
            Trash2: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d="M3 6h18"></path>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
            ),
            LayoutGrid: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
            ),
            Maximize2: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <polyline points="9 21 3 21 3 15"></polyline>
                    <line x1="21" y1="3" x2="14" y2="10"></line>
                    <line x1="3" y1="21" x2="10" y2="14"></line>
                </svg>
            ),
            ClipboardList: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                    <path d="M9 12h.01"></path>
                    <path d="M13 12h2"></path>
                    <path d="M9 16h.01"></path>
                    <path d="M13 16h2"></path>
                </svg>
            ),
            CheckSquare: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <polyline points="9 11 12 14 22 4"></polyline>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                </svg>
            )
        };

        // ==========================================
        // COMPONENTES COMPARTIDOS (UI)
        // ==========================================

        // Modal de Tarea (Simplificado para el ejemplo)
        const TaskModal = ({ isOpen, onClose, onSave, taskToEdit }) => {
            if (!isOpen) return null;
            const [formData, setFormData] = useState({
                id: taskToEdit?.id || Date.now(),
                titulo: taskToEdit?.titulo || '',
                inicio: taskToEdit?.inicio || new Date().toISOString().split('T')[0],
                fin: taskToEdit?.fin || new Date().toISOString().split('T')[0],
                progreso: taskToEdit?.progreso || 0,
                estado: taskToEdit?.estado || 'Pendiente'
            });

            const handleChange = (e) => setFormData({...formData, [e.target.name]: e.target.value});

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div className="bg-white p-6 rounded-lg w-96 shadow-xl">
                        <h2 className="text-xl font-bold mb-4">{taskToEdit ? 'Editar' : 'Nueva'} Tarea</h2>
                        <input name="titulo" value={formData.titulo} onChange={handleChange} placeholder="Título" className="w-full mb-3 p-2 border rounded"/>
                        <div className="flex gap-2 mb-3">
                            <input type="date" name="inicio" value={formData.inicio} onChange={handleChange} className="w-1/2 p-2 border rounded"/>
                            <input type="date" name="fin" value={formData.fin} onChange={handleChange} className="w-1/2 p-2 border rounded"/>
                        </div>
                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                            <button onClick={() => onSave(formData)} className="px-4 py-2 bg-brand-600 text-white rounded hover:bg-brand-700">Guardar</button>
                        </div>
                    </div>
                </div>
            );
        };

        // Tarjeta de Tarea (Vista Lista)
        const TaskCard = ({ task, onEdit, onDelete }) => (
            <div className="bg-white p-4 rounded-lg shadow-sm border border-gray-100 mb-3 hover:shadow-md transition-shadow relative group">
                <div className="flex justify-between items-start">
                    <div>
                        <h3 className="font-semibold text-gray-800">{task.titulo}</h3>
                        <p className="text-xs text-gray-500 mt-1">
                            {new Date(task.inicio).toLocaleDateString()} - {new Date(task.fin).toLocaleDateString()}
                        </p>
                    </div>
                    <span className={`text-xs px-2 py-1 rounded-full ${task.estado === 'Completado' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>
                        {task.estado}
                    </span>
                </div>
                <div className="mt-3 w-full bg-gray-200 rounded-full h-2">
                    <div className="bg-brand-500 h-2 rounded-full" style={{width: `${task.progreso}%`}}></div>
                </div>
                <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                    <button onClick={() => onEdit(task)} className="p-1 text-gray-400 hover:text-brand-600"><Icons.Edit2 size={16}/></button>
                    <button onClick={() => onDelete(task)} className="p-1 text-gray-400 hover:text-red-600"><Icons.Trash2 size={16}/></button>
                </div>
            </div>
        );

        // ==========================================
        // COMPONENTE: VISTA GANTT (Ahora soporta modo Dialog)
        // ==========================================
        const GanttChart = ({ tasks, isDialogMode }) => {
            // Lógica básica de renderizado del Gantt
            const sortedTasks = [...tasks].sort((a, b) => new Date(a.inicio) - new Date(b.inicio));
            
            return (
                <div className={`flex flex-col h-full ${isDialogMode ? 'p-4 bg-white' : ''}`}>
                    {isDialogMode && (
                        <div className="mb-4 pb-4 border-b flex justify-between items-center">
                            <h1 className="text-2xl font-bold text-gray-800">Vista Gantt Ampliada</h1>
                            <div className="text-sm text-gray-500">
                                Sincronizado con Excel vía Office API
                            </div>
                        </div>
                    )}
                    
                    <div className="overflow-auto custom-scroll flex-1 border rounded-lg bg-white">
                        <div className="min-w-[800px] p-4">
                            {sortedTasks.map(task => (
                                <div key={task.id} className="flex items-center mb-4 group">
                                    <div className="w-48 text-sm font-medium truncate pr-4 text-gray-700">{task.titulo}</div>
                                    <div className="flex-1 relative h-8 bg-gray-50 rounded">
                                        {/* Renderizado simplificado de barras para el ejemplo */}
                                        <div 
                                            className="absolute top-1 h-6 rounded bg-brand-500 shadow-sm flex items-center justify-center text-xs text-white overflow-hidden whitespace-nowrap px-2"
                                            style={{
                                                left: '10%', // Valor simulado, en producción calcular basado en fechas
                                                width: `${Math.max(10, task.progreso)}%` // Valor simulado
                                            }}
                                        >
                                            {task.progreso}%
                                        </div>
                                    </div>
                                </div>
                            ))}
                            {tasks.length === 0 && <div className="text-center py-10 text-gray-400">No hay tareas para mostrar</div>}
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // APLICACIÓN PRINCIPAL (LÓGICA DUAL)
        // ==========================================
        const App = () => {
            const [isInitialized, setIsInitialized] = useState(false);
            const [mode, setMode] = useState('loading'); // 'loading', 'taskpane', 'dialog'
            const [tasks, setTasks] = useState([]);
            const [modalOpen, setModalOpen] = useState(false);
            const [dialogRef, setDialogRef] = useState(null);

            // 1. Inicialización de Office y determinación del MODO
            useEffect(() => {
                Office.onReady((info) => {
                    const params = new URLSearchParams(window.location.search);
                    const isDialog = params.get('mode') === 'dialog';

                    if (isDialog) {
                        setMode('dialog');
                        initDialogListener();
                    } else {
                        setMode('taskpane');
                        // Cargar datos iniciales de Excel si estamos en el panel
                        if (info.host === Office.HostType.Excel) {
                            loadTasksFromExcel(); 
                        } else {
                            // Datos falsos para pruebas en navegador web
                            setTasks([
                                {id: 1, titulo: "Tarea Demo 1", inicio: "2024-01-01", fin: "2024-01-05", progreso: 50, estado: "En Proceso"},
                                {id: 2, titulo: "Tarea Demo 2", inicio: "2024-01-06", fin: "2024-01-10", progreso: 20, estado: "Pendiente"}
                            ]);
                        }
                    }
                    setIsInitialized(true);
                });
            }, []);

            // ------------------------------------------
            // LÓGICA DEL MODO DIÁLOGO (HIJO)
            // ------------------------------------------
            const initDialogListener = () => {
                // Registrar manejador para mensajes que vienen del PADRE (Taskpane)
                Office.context.ui.addHandlerAsync(
                    Office.EventType.DialogParentMessageReceived,
                    (arg) => {
                        try {
                            const message = JSON.parse(arg.message);
                            if (message.type === 'DATA_UPDATE') {
                                console.log("Hijo recibió tareas:", message.payload);
                                setTasks(message.payload);
                            }
                        } catch (e) {
                            console.error("Error al procesar mensaje en diálogo:", e);
                        }
                    }
                );

                // Avisar al padre que estamos listos
                setTimeout(() => {
                     Office.context.ui.messageParent(JSON.stringify({ type: 'DIALOG_READY' }));
                }, 500);
            };


            // ------------------------------------------
            // LÓGICA DEL MODO TASKPANE (PADRE)
            // ------------------------------------------
            
            // Función para abrir la ventana emergente
            const openGanttDialog = () => {
                const url = window.location.origin + window.location.pathname + '?mode=dialog';
                
                Office.context.ui.displayDialogAsync(url, { height: 60, width: 80, displayInIframe: true }, 
                    (asyncResult) => {
                        if (asyncResult.status === Office.AsyncResultStatus.Failed) {
                            console.error("Fallo al abrir diálogo:", asyncResult.error.message);
                            return;
                        }

                        const dialog = asyncResult.value;
                        setDialogRef(dialog);

                        // Escuchar mensajes DEL HIJO (Dialog)
                        dialog.addEventHandler(Office.EventType.DialogMessageReceived, (arg) => {
                            try {
                                const msg = JSON.parse(arg.message);
                                if (msg.type === 'DIALOG_READY') {
                                    // El hijo está listo, enviarle los datos actuales
                                    syncDataToDialog(dialog, tasks);
                                }
                            } catch (e) {
                                console.error("Error mensaje desde hijo:", e);
                            }
                        });

                        // Manejar cierre del diálogo
                        dialog.addEventHandler(Office.EventType.DialogEventReceived, (arg) => {
                             if (arg.error === 12006) { // DialogClosed
                                 setDialogRef(null);
                             }
                        });
                    }
                );
            };

            // Función auxiliar para enviar datos al hijo
            const syncDataToDialog = (dialogInstance, currentTasks) => {
                if (dialogInstance) {
                    const message = JSON.stringify({
                        type: 'DATA_UPDATE',
                        payload: currentTasks
                    });
                    // API Office Dialog: Parent -> Child
                    dialogInstance.messageChild(message);
                }
            };

            // Simulación de carga desde Excel (simplificada)
            const loadTasksFromExcel = async () => {
                try {
                    await Excel.run(async (context) => {
                        // Aquí iría tu lógica real de lectura de Excel
                        // Por ahora usamos un mock para que funcione el ejemplo
                        console.log("Leyendo desde Excel...");
                    });
                } catch (error) {
                    console.error(error);
                }
            };

            // Crear nueva tarea y sincronizar
            const handleSaveTask = (newTask) => {
                const updatedTasks = [...tasks, newTask];
                setTasks(updatedTasks);
                setModalOpen(false);
                
                // Si el diálogo está abierto, enviar actualización en tiempo real
                if (dialogRef) {
                    syncDataToDialog(dialogRef, updatedTasks);
                }
            };

            // ------------------------------------------
            // RENDERIZADO CONDICIONAL
            // ------------------------------------------

            if (!isInitialized) return <div className="p-10 text-center">Cargando Office...</div>;

            // RENDER: MODO DIÁLOGO (Solo el Gantt)
            if (mode === 'dialog') {
                return (
                    <div className="h-screen w-screen bg-gray-50">
                        <GanttChart tasks={tasks} isDialogMode={true} />
                    </div>
                );
            }

            // RENDER: MODO PANEL DE TAREAS (UI Principal)
            return (
                <div className="min-h-screen pb-20">
                    {/* Header */}
                    <div className="sticky top-0 bg-white border-b z-10 px-4 py-3 flex justify-between items-center shadow-sm">
                        <div className="flex items-center gap-2 text-brand-700 font-bold text-lg">
                            <Icons.LayoutGrid size={24} />
                            <span>CronosTask</span>
                        </div>
                        <button 
                            onClick={openGanttDialog}
                            className="p-2 bg-brand-50 text-brand-600 rounded-lg hover:bg-brand-100 transition-colors"
                            title="Abrir Gantt en Ventana"
                        >
                            <Icons.Maximize2 size={20} />
                        </button>
                    </div>

                    {/* Dashboard */}
                    <div className="p-4 space-y-4">
                        <div className="grid grid-cols-2 gap-3">
                            <div className="bg-white p-3 rounded-lg border border-gray-100 shadow-sm">
                                <span className="text-gray-500 text-xs uppercase font-bold">Total</span>
                                <div className="text-2xl font-bold text-gray-800">{tasks.length}</div>
                            </div>
                            <div className="bg-white p-3 rounded-lg border border-gray-100 shadow-sm">
                                <span className="text-gray-500 text-xs uppercase font-bold">Completadas</span>
                                <div className="text-2xl font-bold text-green-600">
                                    {tasks.filter(t => t.estado === 'Completado').length}
                                </div>
                            </div>
                        </div>

                        {/* Lista de Tareas */}
                        <div>
                            <div className="flex justify-between items-center mb-3">
                                <h2 className="font-semibold text-gray-700">Mis Actividades</h2>
                                <button onClick={() => setModalOpen(true)} className="text-sm text-brand-600 font-medium hover:underline">
                                    + Nueva
                                </button>
                            </div>
                            
                            {tasks.length > 0 ? (
                                tasks.map(task => (
                                    <TaskCard key={task.id} task={task} onEdit={() => {}} onDelete={() => {}} />
                                ))
                            ) : (
                                <div className="text-center py-10 opacity-60">
                                    <Icons.ClipboardList className="mx-auto mb-2 text-gray-400" size={32}/>
                                    <p>Sin tareas registradas</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Modales */}
                    <TaskModal isOpen={modalOpen} onClose={() => setModalOpen(false)} onSave={handleSaveTask} taskToEdit={null} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma de Trabajo | SPRC</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1' }
                    }
                }
            }
        }
    </script>
    
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #475569; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-slate-900 dark:text-gray-100 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Iconos ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase());
                    ref.current.appendChild(i);
                    lucide.createIcons({ root: ref.current, attrs: { width: size, height: size, class: className } });
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex" />;
        };

        const Icons = {
            Plus: (p) => <Icon name="Plus" {...p} />,
            Trash2: (p) => <Icon name="Trash2" {...p} />,
            Edit2: (p) => <Icon name="Edit2" {...p} />,
            Calendar: (p) => <Icon name="Calendar" {...p} />,
            CheckSquare: (p) => <Icon name="CheckSquare" {...p} />,
            Save: (p) => <Icon name="Save" {...p} />,
            X: (p) => <Icon name="X" {...p} />,
            Moon: (p) => <Icon name="Moon" {...p} />,
            Sun: (p) => <Icon name="Sun" {...p} />,
            ExternalLink: (p) => <Icon name="ExternalLink" {...p} />,
            LayoutGrid: (p) => <Icon name="LayoutGrid" {...p} />,
            BarChart3: (p) => <Icon name="BarChart3" {...p} />,
            ChevronDown: (p) => <Icon name="ChevronDown" {...p} />,
            ChevronUp: (p) => <Icon name="ChevronUp" {...p} />,
        };

        // --- Vista Gantt Mejorada con Llenado Visual ---
        const GanttView = ({ tasks, onEdit }) => {
            const { dates, minDate } = useMemo(() => {
                if (tasks.length === 0) return { dates: [], minDate: new Date() };
                const allDates = tasks.flatMap(t => [new Date(t.fechaInicio), new Date(t.fechaFin)]);
                const min = new Date(Math.min(...allDates));
                min.setDate(min.getDate() - 2);
                const max = new Date(Math.max(...allDates));
                max.setDate(max.getDate() + 7);
                const arr = [];
                for(let d = new Date(min); d <= max; d.setDate(d.getDate() + 1)) arr.push(new Date(d));
                return { dates: arr, minDate: min };
            }, [tasks]);

            const dayWidth = 40;

            return (
                <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 overflow-hidden flex flex-col h-[600px]">
                    <div className="flex-1 overflow-auto custom-scrollbar relative">
                        <div style={{ width: `${dates.length * dayWidth + 200}px` }}>
                            <div className="flex sticky top-0 z-20 bg-gray-50 dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 h-10">
                                <div className="sticky left-0 w-52 bg-gray-50 dark:bg-slate-800 border-r p-2 font-bold text-xs z-30">Tarea</div>
                                {dates.map((d, i) => (
                                    <div key={i} className="flex-shrink-0 border-r border-gray-100 dark:border-slate-700 text-[10px] text-center flex items-center justify-center" style={{ width: dayWidth }}>
                                        {d.getDate()}
                                    </div>
                                ))}
                            </div>
                            {tasks.map(task => {
                                const start = new Date(task.fechaInicio);
                                const end = new Date(task.fechaFin);
                                const offset = Math.floor((start - minDate) / 86400000);
                                const duration = Math.max(1, Math.ceil((end - start) / 86400000) + 1);

                                return (
                                    <div key={task.id} className="flex border-b border-gray-50 dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700/50 h-12">
                                        <div className="sticky left-0 w-52 bg-white dark:bg-slate-800 border-r p-2 text-xs truncate z-10 cursor-pointer flex items-center" onClick={() => onEdit(task)}>
                                            {task.titulo}
                                        </div>
                                        <div className="relative flex-1 py-2">
                                            <div 
                                                className="absolute h-8 rounded bg-blue-100 dark:bg-blue-900/30 overflow-hidden shadow-sm border border-white/20 cursor-pointer"
                                                style={{ left: offset * dayWidth, width: duration * dayWidth }}
                                                onClick={() => onEdit(task)}
                                            >
                                                {/* BARRA DE LLENADO DE PROGRESO */}
                                                <div 
                                                    className="h-full bg-brand-500 transition-all duration-500"
                                                    style={{ width: `${task.progreso}%` }}
                                                ></div>
                                                <div className="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-blue-900 dark:text-white drop-shadow-sm">
                                                    {task.progreso}%
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Modales ---
        const TaskModal = ({ isOpen, onClose, onSave, taskToEdit }) => {
            const [data, setData] = useState({ titulo: '', responsable: '', fechaInicio: '', fechaFin: '', progreso: 0, estado: 'Pendiente', subprocesos: [] });
            
            useEffect(() => {
                if (isOpen) {
                    if (taskToEdit) setData(taskToEdit);
                    else setData({ id: Date.now(), titulo: '', responsable: '', fechaInicio: new Date().toISOString().split('T')[0], fechaFin: new Date().toISOString().split('T')[0], progreso: 0, estado: 'Pendiente', subprocesos: [] });
                }
            }, [isOpen, taskToEdit]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4">
                    <div className="bg-white dark:bg-slate-800 rounded-xl w-full max-w-lg p-6 shadow-2xl">
                        <h2 className="text-xl font-bold mb-4">{taskToEdit ? 'Editar Tarea' : 'Nueva Tarea'}</h2>
                        <div className="space-y-4">
                            <input type="text" placeholder="Título" value={data.titulo} onChange={e => setData({...data, titulo: e.target.value})} className="w-full p-2 border rounded dark:bg-slate-700" />
                            <div className="grid grid-cols-2 gap-4">
                                <input type="date" value={data.fechaInicio} onChange={e => setData({...data, fechaInicio: e.target.value})} className="p-2 border rounded dark:bg-slate-700" />
                                <input type="date" value={data.fechaFin} onChange={e => setData({...data, fechaFin: e.target.value})} className="p-2 border rounded dark:bg-slate-700" />
                            </div>
                            <div>
                                <label className="text-sm block mb-1">Progreso: {data.progreso}%</label>
                                <input type="range" min="0" max="100" value={data.progreso} onChange={e => setData({...data, progreso: parseInt(e.target.value)})} className="w-full" />
                            </div>
                            <select value={data.estado} onChange={e => setData({...data, estado: e.target.value})} className="w-full p-2 border rounded dark:bg-slate-700">
                                <option>Pendiente</option>
                                <option>En Progreso</option>
                                <option>Completado</option>
                            </select>
                        </div>
                        <div className="flex justify-end gap-2 mt-6">
                            <button onClick={onClose} className="px-4 py-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded">Cancelar</button>
                            <button onClick={() => { onSave(data); onClose(); }} className="px-4 py-2 bg-brand-600 text-white rounded">Guardar</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- App Principal ---
        const App = () => {
            const [tasks, setTasks] = useState([]);
            const [viewMode, setViewMode] = useState('list');
            const [modalOpen, setModalOpen] = useState(false);
            const [editingTask, setEditingTask] = useState(null);
            const [darkMode, setDarkMode] = useState(false);
            const [officeReady, setOfficeReady] = useState(false);

            useEffect(() => {
                Office.onReady(info => {
                    if (info.host === Office.HostType.Excel) {
                        setOfficeReady(true);
                        loadTasks();
                    }
                });

                // Si estamos en la ventana emergente, avisar al padre para refrescar si hay cambios
                if (window.location.search.includes('isDialog=true')) {
                    // Lógica especial para cuando se abre como diálogo
                }
            }, []);

            const loadTasks = async () => {
                try {
                    await Excel.run(async (context) => {
                        const sheet = context.workbook.worksheets.getItem("Cronograma");
                        const range = sheet.getUsedRange();
                        range.load("values");
                        await context.sync();
                        const [header, ...rows] = range.values;
                        setTasks(rows.map((r, i) => ({
                            id: r[0] || i, titulo: r[1], responsable: r[2], 
                            fechaInicio: r[3], fechaFin: r[4], progreso: parseInt(r[5] || 0), 
                            estado: r[6], subprocesos: []
                        })));
                    });
                } catch(e) { console.log("Excel no disponible, modo offline."); }
            };

            const saveTasksToExcel = async (newTasks) => {
                if (!officeReady) return;
                try {
                    await Excel.run(async (context) => {
                        const sheet = context.workbook.worksheets.getItem("Cronograma");
                        sheet.getRange("A2:G100").clear();
                        const values = newTasks.map(t => [t.id, t.titulo, t.responsable, t.fechaInicio, t.fechaFin, t.progreso, t.estado]);
                        const range = sheet.getRangeByIndexes(1, 0, values.length, 7);
                        range.values = values;
                        await context.sync();
                    });
                } catch(e) { console.error("Error al guardar en Excel."); }
            };

            const handleSaveTask = (task) => {
                const newTasks = tasks.some(t => t.id === task.id) 
                    ? tasks.map(t => t.id === task.id ? task : t)
                    : [...tasks, task];
                setTasks(newTasks);
                saveTasksToExcel(newTasks);
                
                // Si esto es un diálogo, enviar mensaje al panel lateral
                if (Office.context.ui && Office.context.ui.messageParent) {
                    Office.context.ui.messageParent(JSON.stringify({ type: 'REFRESH' }));
                }
            };

            const openPopup = () => {
                const url = window.location.href + (window.location.href.includes('?') ? '&' : '?') + 'isDialog=true';
                Office.context.ui.displayDialogAsync(url, { height: 90, width: 90 }, (result) => {
                    if (result.status === Office.AsyncResultStatus.Succeeded) {
                        const dialog = result.value;
                        dialog.addEventHandler(Office.EventType.DialogMessageReceived, (arg) => {
                            const msg = JSON.parse(arg.message);
                            if (msg.type === 'REFRESH') loadTasks();
                            dialog.close();
                        });
                    }
                });
            };

            return (
                <div className={darkMode ? 'dark' : ''}>
                    <div className="min-h-screen bg-gray-50 dark:bg-slate-900 dark:text-white p-4">
                        <header className="flex justify-between items-center mb-6">
                            <div>
                                <h1 className="text-xl font-bold flex items-center gap-2">
                                    <Icons.CheckSquare className="text-brand-600" /> Cronograma SPRC
                                </h1>
                                <p className="text-xs text-gray-400">Panel de Control de Actividades</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setDarkMode(!darkMode)} className="p-2 rounded-lg bg-white dark:bg-slate-800 shadow-sm border border-gray-200 dark:border-slate-700">
                                    {darkMode ? <Icons.Sun /> : <Icons.Moon />}
                                </button>
                                <button onClick={openPopup} className="p-2 rounded-lg bg-white dark:bg-slate-800 shadow-sm border border-gray-200 dark:border-slate-700 text-purple-600">
                                    <Icons.ExternalLink />
                                </button>
                                <button onClick={() => setModalOpen(true)} className="bg-brand-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-lg shadow-brand-500/30">
                                    <Icons.Plus /> Nueva
                                </button>
                            </div>
                        </header>

                        <div className="flex justify-between items-center mb-4">
                            <div className="flex bg-white dark:bg-slate-800 p-1 rounded-lg border border-gray-200 dark:border-slate-700">
                                <button onClick={() => setViewMode('list')} className={`p-2 rounded ${viewMode === 'list' ? 'bg-brand-100 dark:bg-brand-900/30 text-brand-700' : ''}`}><Icons.LayoutGrid /></button>
                                <button onClick={() => setViewMode('gantt')} className={`p-2 rounded ${viewMode === 'gantt' ? 'bg-brand-100 dark:bg-brand-900/30 text-brand-700' : ''}`}><Icons.BarChart3 /></button>
                            </div>
                        </div>

                        {viewMode === 'list' ? (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {tasks.map(t => (
                                    <div key={t.id} className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700">
                                        <div className="flex justify-between items-start mb-2">
                                            <h3 className="font-bold truncate pr-4">{t.titulo}</h3>
                                            <button onClick={() => { setEditingTask(t); setModalOpen(true); }} className="text-blue-500"><Icons.Edit2 size={16} /></button>
                                        </div>
                                        <div className="w-full bg-gray-100 dark:bg-slate-700 h-2 rounded-full overflow-hidden mb-2">
                                            <div className="bg-brand-500 h-full" style={{width: `${t.progreso}%`}}></div>
                                        </div>
                                        <div className="flex justify-between text-[10px] text-gray-500">
                                            <span>{t.fechaInicio}</span>
                                            <span className="font-bold">{t.progreso}%</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <GanttView tasks={tasks} onEdit={(t) => { setEditingTask(t); setModalOpen(true); }} />
                        )}
                    </div>
                    <TaskModal isOpen={modalOpen} onClose={() => setModalOpen(false)} onSave={handleSaveTask} taskToEdit={editingTask} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
